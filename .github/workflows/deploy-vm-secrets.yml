# ==========================================
# Deploy to VM using Google Secret Manager
# ==========================================
# Most secure option: Secrets stored encrypted in GCP Secret Manager
# Access is logged and can be revoked

name: Deploy to VM (Secret Manager)

on:
  push:
    branches: [master, main]
  workflow_dispatch:

env:
  PROJECT_ID: your-gcp-project-id  # CHANGE THIS
  ZONE: us-central1-a              # CHANGE THIS if needed
  SSH_USER: ubuntu                 # Your VM username

jobs:
  deploy:
    name: Deploy to VM
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_IP }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            cd ~/cocheras
            git pull origin master

            # Install gcloud if not present
            if ! command -v gcloud &> /dev/null; then
              curl -sSL https://sdk.cloud.google.com | bash
              export PATH=$PATH:$HOME/google-cloud-sdk/bin
            fi

            # Fetch secrets from Secret Manager
            gcloud secrets versions access latest --secret="cocheras-env" --project="${{ env.PROJECT_ID }}" > .env

            # Start services
            docker-compose -f docker-compose.prod.yml --profile local build
            docker-compose -f docker-compose.prod.yml --profile local up -d

            # Wait for MySQL
            sleep 10

            # Run migrations
            docker-compose -f docker-compose.prod.yml --profile local exec -T api \
              node dist/shared/db/migration-runner.js

            # Remove .env
            rm .env

            echo "âœ… Deployment complete!"
